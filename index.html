<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>API-KEY信息查询</title>
		<link rel="icon" href="data:image/png;base64,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
">
		<style>
			body {
				background-color: #497e7e;
			}

			table {
				margin: auto;
				border-collapse: collapse;
			}

			th,
			td {
				padding: 8px;
				text-align: center;
				color: #000000;
				border: 1px solid #000000;
			}

			th:first-child,
			td:first-child {
				width: 520px;
			}

			h1 {
				text-align: center;
				color: #000000;
			}

			form {
				display: flex;
				justify-content: center;
				align-items: center;
				margin-bottom: 20px;
			}

			textarea#api-key-input {
				width: 430px;
				font-size: 16px;
				padding: 10px;
				margin-right: 10px;
				border-radius: 5px;
				border: none;
				resize: vertical;
				rows: 8;
			}

			select#api-url-select,
			input#custom-url-input {
				width: 300px;
				height: 50px;
				font-size: 16px;
				background-color: #212121;
				border-radius: 5px;
				color: #ffffff;
				border: none;
				margin-right: 10px;
			}

			input#custom-url-input {
				display: none;
			}

			button {
				height: 50px;
				font-size: 16px;
				background-color: #ff8c00;
				color: #ffffff;
				border: none;
				border-radius: 5px;
				cursor: pointer;
			}

			.status-ok {
				color: #2d8d2d;
			}

			.status-error {
				color: #7e1707;
			}

			tr:nth-child(even) {
				/* 将偶数行背景色改为深蓝色 */
				background-color: #f1d39c;
			}

			tr:nth-child(odd) {
				/* 将偶数行背景色改为深蓝色 */
				background-color: #f1d39c;
			}
		</style>
	</head>
	<body>
		<h1>API-KEY信息查询</h1>
		<form>
			<textarea id="api-key-input" placeholder="请输入API KEY，每行一个"></textarea>
			<div style="display: flex; align-items: flex-end">
				<select id="api-url-select">
					<option value="https://chatgpt-proxy.v50.ltd">【社区反代】 https://chatgpt-proxy.v50.ltd</option>
					<option value="https://api.openai.com">【官方,需科学】 https://api.openai.com</option>
					<option value="custom">自定义 ...</option>
				</select>
				<input type="text" id="custom-url-input" placeholder="请输入自定义API链接" />
			</div>
			<button type="button" onclick="sendRequest()">发送请求</button>
		</form>
		<table id="result-table">
			<thead>
				<tr>
					<th>API KEY</th>
					<th style="width: 350px">用户ID</th>
					<th style="width: 50px">总额度</th>
					<th style="width: 185px">已使用</th>
					<th style="width: 90px">剩余额度</th>
					<th style="width: 90px">有效期起</th>
					<th style="width: 90px">有效期至</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
		<script>
			// 定义查询过的API-KEY列表
			let queriedApiKeys = [];

			function sendRequest() {
				let apiKeyInput = document.getElementById("api-key-input");
				let apiUrlSelect = document.getElementById("api-url-select");
				let customUrlInput = document.getElementById("custom-url-input");

				if (apiKeyInput.value.trim() === "") {
					alert("请填写API KEY");
					return;
				}

				// 添加以下一行代码，清空之前的结果信息
				document.getElementById("result-table").getElementsByTagName('tbody')[0].innerHTML = "";

				let apiUrl = "";
				if (apiUrlSelect.value === "custom") {
					if (customUrlInput.value.trim() === "") {
						alert("请设置API链接");
						return;
					} else {
						apiUrl = customUrlInput.value.trim();
					}
				} else {
					apiUrl = apiUrlSelect.value;
				}

				let apiKeys = apiKeyInput.value.trim().split("\n");

				let tableBody = document.querySelector("#result-table tbody");
				for (let i = 0; i < apiKeys.length; i++) {
					let apiKey = apiKeys[i].trim();
					// 判断是否已经查询过
					if (queriedApiKeys.includes(apiKey)) {
						console.log(`API KEY ${apiKey} 已查询过，跳过此次查询`);
						continue;
					}
					queriedApiKeys.push(apiKey);

					checkBilling(apiKey, apiUrl)
						.then((data) => {
							// update table with data
							let row = document.createElement("tr");

							// API KEY
							let apiKeyCell = document.createElement("td");
							apiKeyCell.textContent = apiKey;
							row.appendChild(apiKeyCell);

							if (data.hasOwnProperty("error")) {
								// ERROR MESSAGE
								let errorMessageCell = document.createElement("td");
								errorMessageCell.colSpan = "6";
								errorMessageCell.classList.add("status-error");

								if (data.error.code === "invalid_api_key") {
									errorMessageCell.textContent = "不正确或已失效的API-KEY";
								} else if (data.error.code === "account_deactivated") {
									errorMessageCell.textContent = "该openai账号已被封禁";
								} else {
									errorMessageCell.textContent = "未知错误";
								}

								row.appendChild(errorMessageCell);
							} else {
								// ID
								let IDCell = document.createElement("td");
								// IDCell.textContent = data.grants.data[0].id;
								IDCell.textContent = "";
								row.appendChild(IDCell);

								// TOTAL GRANTED
								let totalGrantedCell = document.createElement("td");
								// totalGrantedCell.textContent = data.total_granted;
								totalGrantedCell.textContent = data[0];
								row.appendChild(totalGrantedCell);

								// TOTAL USED
								let totalUsedCell = document.createElement("td");
								// totalUsedCell.textContent = data.total_used;
								totalUsedCell.textContent = data[1];
								row.appendChild(totalUsedCell);

								// TOTAL AVAILABLE
								let totalAvailableCell = document.createElement("td");
								// totalAvailableCell.textContent = data.total_available;
								totalAvailableCell.textContent = data[2];
								row.appendChild(totalAvailableCell);

								// EFFECTIVE FROM
								let effectiveFromCell = document.createElement("td");
								// effectiveFromCell.textContent = new Date(
								// 	data.grants.data[0].effective_at * 1000
								// ).toLocaleDateString();
								effectiveFromCell.textContent = "";
								row.appendChild(effectiveFromCell);

								// EXPIRES AT
								let expiresAtCell = document.createElement("td");
								// expiresAtCell.textContent = new Date(
								// 	data.grants.data[0].expires_at * 1000
								// ).toLocaleDateString();
								expiresAtCell.textContent = "";
								row.appendChild(expiresAtCell);
							}

							tableBody.appendChild(row);

							// 添加以下代码，查询完成后删除已查询的API-KEY
							if (i === apiKeys.length - 1) {
								queriedApiKeys = [];
							}
						})
						.catch((error) => {
							console.error(error);
							// update table with error message
							let row = document.createElement("tr");
							let apiKeyCell = document.createElement("td");
							apiKeyCell.textContent = apiKey;
							row.appendChild(apiKeyCell);

							if (error.name === "AbortError") {
								let errorMessageCell = document.createElement("td");
								errorMessageCell.colSpan = "6";
								errorMessageCell.style.width = "90px";
								errorMessageCell.classList.add("status-error");
								errorMessageCell.textContent = "请求超时";
								row.appendChild(errorMessageCell);
							} else {
								let errorMessageCell = document.createElement("td");
								errorMessageCell.colSpan = "6";
								errorMessageCell.style.width = "90px";
								errorMessageCell.classList.add("status-error");
								errorMessageCell.textContent =
									"API请求失败，请检查其有效性或网络情况";
								row.appendChild(errorMessageCell);
							}

							tableBody.appendChild(row);

							// 添加以下代码，查询完成后删除已查询的API-KEY
							if (i === apiKeys.length - 1) {
								queriedApiKeys = [];
							}
						});
				}
			}

			let apiUrlSelect = document.getElementById("api-url-select");
			let customUrlInput = document.getElementById("custom-url-input");

			apiUrlSelect.addEventListener("change", function() {
				if (apiUrlSelect.value === "custom") {
					customUrlInput.style.display = "inline-block";
					customUrlInput.style.marginTop = "5px";
				} else {
					customUrlInput.style.display = "none";
				}
			});
			
			async function checkBilling(apiKey, apiUrl) {
				// 计算起始日期和结束日期
				const now = new Date();
				startDate = new Date(now - 90 * 24 * 60 * 60 * 1000);
				const endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
			
				// 设置API请求URL和请求头
				const urlSubscription = apiUrl + '/v1/dashboard/billing/subscription'; // 查是否订阅
				const urlBalance = apiUrl + '/dashboard/billing/credit_grants'; // 查普通账单
				urlUsage =
					apiUrl + `/v1/dashboard/billing/usage?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`; // 查使用量
				const headers = {
					"Authorization": "Bearer " + apiKey,
					"Content-Type": "application/json"
				};
			
				try {
					// 获取API限额
					let response = await fetch(urlSubscription, {
						headers
					});
					if (!response.ok) {
						console.log("您的账户已被封禁，请登录OpenAI进行查看。");
						return;
					}
					const subscriptionData = await response.json();
			
					// 判断是否过期
					const timestamp_now = Math.floor(Date.now() / 1000);
					const timestamp_expire = subscriptionData.access_until;
					if (timestamp_now > timestamp_expire) {
						alert("您的账户额度已过期, 请登录OpenAI进行查看。");
					}
			
					const totalAmount = subscriptionData.hard_limit_usd;
					const is_subsrcibed = subscriptionData.has_payment_method;
			
					// 获取已使用量
					response = await fetch(urlUsage, {
						headers
					});
					usageData = await response.json();
					totalUsage = usageData.total_usage / 100;
			
					// 如果用户绑卡，额度每月会刷新
					if (is_subsrcibed) {
						// 获取当前月的第一天日期
						const day = now.getDate(); // 本月过去的天数
						startDate = new Date(now - (day - 1) * 24 * 60 * 60 * 1000); // 本月第一天
						urlUsage =
							apiUrl + `/v1/dashboard/billing/usage?start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}`; // 查使用量
						response = await fetch(urlUsage, {
							headers
						});
						usageData = await response.json();
						totalUsage = usageData.total_usage / 100;
					}
			
					// 计算剩余额度
					const remaining = totalAmount - totalUsage;
			
					// 输出总用量、总额及余额信息
					console.log(`Total Amount: ${totalAmount.toFixed(2)}`);
					console.log(`Used: ${totalUsage.toFixed(2)}`);
					console.log(`Remaining: ${remaining.toFixed(2)}`);
			
					return [totalAmount, totalUsage, remaining];
				} catch (error) {
					console.error(error);
					alert("您的IP无法访问OpenAI，请在OpenAI服务范围内查询。");
					return [null, null, null];
				}
			}

			function formatDate(date) {
				const year = date.getFullYear();
				const month = (date.getMonth() + 1).toString().padStart(2, '0');
				const day = date.getDate().toString().padStart(2, '0');

				return `${year}-${month}-${day}`;
			}
		</script>
	</body>

</html>